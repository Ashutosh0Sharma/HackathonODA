"use strict";

let config = require("../config");
let request = require("request");

let https = require('https')

let fs = require("fs");


class NearestParkingDetails2 {
    metadata() {
        return {
            "name": "getNear",
            "properties": {
                "xCoordinate": {
                    "type": "string",
                    "required": true
                },
                "yCoordinate": {
                    "type": "string",
                    "required": true
                },
                "carType": {
                    "type": "string",
                    "required": true
                },
                "placeName": {
                    "type": "string",
                    "required": true
                }


            },
            "supportedActions": [
                "BookingSuccess", "BookingFailure"
            ]
        }
    }

    invoke(conversation, done) {

        let xCoordinate = conversation.properties().xCoordinate;
        let yCoordinate = conversation.properties().yCoordinate;
        let carType = conversation.properties().carType;
        let placeName = conversation.properties().placeName;
        let checkIn = new Date(conversation.variable("selectedDate")).toLocaleString()
        let checkOut = conversation.variable("selectedDate1") ? new Date(conversation.variable("selectedDate1")).toLocaleString() : ""


        let durt, height;
        // let level = conversation.variable("level");
        let url = config.CUSTOMER.GetParkingUrl;

        console.log(url)

        if (carType == "SUV") {
            height = 2.5;
        }
        else {
            height = 2;
        }

        if (placeName != "${location.value}") {
            url = url + "&q=" + placeName;
        }


        let options = {
            url: url,
            method: 'GET',

        };

        function callback(error, response, body) {



            if (!error && response.statusCode == 200) {
                var parkingDetails = body;
                var filtered, count = 0, distanceArray = [];
                parkingDetails = JSON.parse(parkingDetails);
                parkingDetails = parkingDetails.result.records;
                console.log(parkingDetails);
                let parkDetailsArr = [];
                if (placeName != "${location.value}") {
                    for (let i = 0; i < parkingDetails.length; i++) {
                        if ((parkingDetails[i].gantry_height >= height)) {


                            count++;
                            console.log(count);

                            parkDetailsArr.push({
                                title: parkingDetails[i].address.toString(),
                                description: "\nCar Park Number: " + parkingDetails[i].car_park_no.toString() +
                                    "\nCar Park Type: " + parkingDetails[i].car_park_type.toString() +
                                    "\nType of Parking System: " + parkingDetails[i].type_of_parking_system.toString()

                            })

                        }
                    }
                }
                else {
                    for (let i = 0; i < parkingDetails.length; i++) {
                        if ((parkingDetails[i].gantry_height >= height)) {

                            count++;
                            var lat2 = yCoordinate;
                            var lon2 = xCoordinate;
                            var lat1 = parkingDetails[i].y_coord;
                            var lon1 = parkingDetails[i].x_coord;

                            var R = 6371; // km 

                            var x1 = lat2 - lat1;
                            var dLat = x1 * Math.PI / 180;
                            var x2 = lon2 - lon1;
                            var dLon = x2 * Math.PI / 180;
                            var a = Math.sin(dLat / 2) * Math.sin(dLat / 2) +
                                Math.cos(lat1 * Math.PI / 180) * Math.cos(lat2 * Math.PI / 180) *
                                Math.sin(dLon / 2) * Math.sin(dLon / 2);
                            var c = 2 * Math.atan2(Math.sqrt(a), Math.sqrt(1 - a));
                            var d = R * c;


                            distanceArray.push({
                                srNo: i,
                                distance: d,
                                address: parkingDetails[i].address.toString(),
                                carParkNo: parkingDetails[i].car_park_no.toString(),
                                carParkType: parkingDetails[i].car_park_type.toString(),
                                typeParkingSystem: parkingDetails[i].type_of_parking_system.toString()
                            })


                        }
                    }
                    distanceArray.sort(function (a, b) {
                        return a.distance - b.distance;
                    });
                    for (let i = 0; i < distanceArray.length; i++) {
                        parkDetailsArr.push({
                            title: distanceArray[i].address.toString(),
                            description: "\nCar Park Number: " + distanceArray[i].carParkNo.toString() +
                                "\nCar Park Type: " + distanceArray[i].carParkType.toString() +
                                "\nType of Parking System: " + distanceArray[i].typeParkingSystem.toString()
                        })
                    }

                }


                if (count != 0) {

                    conversation.variable("ParkingDetails", parkDetailsArr)
                    conversation.variable("checkIn", checkIn)
                    conversation.variable("checkOut", checkOut)



                    conversation.keepTurn(true)
                    conversation.transition("BookingSuccess");

                    done();
                }
                else {
                    conversation.transition("BookingFailure");
                    conversation.keepTurn(true)

                    done();
                }


            }
            else {
                conversation.reply("Oops! There is some technical issue at the backend. Please try again later.")
                conversation.keepTurn(true)

                done();
            }
        }
        request(options, callback)
    }

}

module.exports = new NearestParkingDetails2();